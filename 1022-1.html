<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>å³æ™‚ç©ºæ°£å“è³ªæŸ¥è©¢</title>

<style>
  /* ===== å…¨åŸŸèƒŒæ™¯ ===== */
  body {
    font-family: "Segoe UI", "Noto Sans TC", sans-serif;
    padding: 60px;
    background: linear-gradient(145deg, #eef2f7, #f9fbff);
    font-size: 20px;
    color: #2c3e50;
  }

  h2 {
    font-size: 36px;
    margin-bottom: 35px;
    letter-spacing: 1px;
  }

  /* ===== è¼¸å…¥å€ ===== */
  input {
    font-size: 20px;
    padding: 12px 16px;
    border-radius: 12px;
    border: 1px solid #ccd3dd;
    outline: none;
    transition: 0.3s;
  }

  input:focus {
    border-color: #4facfe;
    box-shadow: 0 0 0 4px rgba(79,172,254,0.15);
  }

  /* ===== æŒ‰éˆ• ===== */
  button {
    font-size: 20px;
    padding: 12px 30px;
    border-radius: 14px;
    border: none;
    cursor: pointer;
    margin-left: 10px;
    background: linear-gradient(135deg, #4facfe, #00c6ff);
    color: #fff;
    font-weight: 600;
    letter-spacing: 1px;
    box-shadow: 0 10px 25px rgba(79,172,254,0.35);
    transition: transform 0.2s, box-shadow 0.2s;
  }

  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 14px 30px rgba(79,172,254,0.45);
  }

  button:active {
    transform: translateY(0);
    box-shadow: 0 8px 20px rgba(79,172,254,0.3);
  }

  /* ===== è¡¨æ ¼ ===== */
  table {
    border-collapse: collapse;
    margin-top: 40px;
    width: 100%;
    font-size: 20px;
    background: white;
    border-radius: 18px;
    overflow: hidden;
    box-shadow: 0 18px 40px rgba(0,0,0,0.08);
  }

  thead {
    background: linear-gradient(135deg, #4facfe, #00c6ff);
    color: white;
  }

  th, td {
    padding: 18px;
    text-align: center;
  }

  th {
    font-weight: 600;
    letter-spacing: 1px;
  }

  tbody tr {
    transition: background 0.2s;
  }

  tbody tr:hover {
    background: #f2f7ff;
  }

  tbody tr:not(:last-child) td {
    border-bottom: 1px solid #e5e9f2;
  }
</style>
</head>

<body>

<h2>ç›®å‰ä½ç½®ç©ºæ°£å“è³ªæŸ¥è©¢</h2>

æš±ç¨±ï¼š
<input type="text" id="name" placeholder="è¼¸å…¥æš±ç¨±">
<button onclick="getMyAQI()">æŸ¥è©¢æˆ‘ç›®å‰çš„ç©ºæ°£å“è³ª</button>

<table>
  <thead>
    <tr>
      <th>æš±ç¨±</th>
      <th>æ‰€åœ¨ä½ç½®</th>
      <th>æœ€è¿‘æ¸¬ç«™</th>
      <th>AQI</th>
      <th>ç©ºæ°£å“è³ª</th>
    </tr>
  </thead>
  <tbody id="result"></tbody>
</table>

<!-- ğŸ”´ JS å®Œå…¨ä¸å‹• -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBM36LbTtWYGEnuT_-MUqOy4lQct2nC8Cc",
  authDomain: "air1022.firebaseapp.com",
  projectId: "air1022",
  storageBucket: "air1022.firebasestorage.app",
  messagingSenderId: "1028093617614",
  appId: "1:1028093617614:web:c3d5c3740317eb5103379f",
  measurementId: "G-PJVDR9BG9S"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const API_KEY = "c5f73ea7-714a-46fa-bb43-f7421cbcbdb2";
let aqiData = [];

fetch(`https://data.moenv.gov.tw/api/v2/aqx_p_432?api_key=${API_KEY}&format=JSON`)
  .then(res => res.json())
  .then(data => aqiData = data.records);

function distance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat/2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) *
    Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon/2) ** 2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

async function saveToFirebaseCollections(name, nearest) {
  await addDoc(collection(db, "records"), {
    name,
    location: `${nearest.county} ${nearest.sitename}`,
    aqi: nearest.aqi,
    status: nearest.status,
    time: new Date().toLocaleString()
  });
}

window.getMyAQI = function() {
  const name = document.getElementById("name").value || "åŒ¿å";

  if (aqiData.length === 0) {
    alert("ç©ºæ°£å“è³ªè³‡æ–™å°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨å¾Œå†è©¦");
    return;
  }

  navigator.geolocation.getCurrentPosition(async pos => {
    const myLat = pos.coords.latitude;
    const myLon = pos.coords.longitude;

    let nearest = null;
    let minDist = Infinity;

    aqiData.forEach(item => {
      if (!item.latitude || !item.longitude) return;

      const d = distance(
        myLat, myLon,
        parseFloat(item.latitude),
        parseFloat(item.longitude)
      );

      if (d < minDist) {
        minDist = d;
        nearest = item;
      }
    });

    document.getElementById("result").innerHTML = `
      <tr>
        <td>${name}</td>
        <td>(${myLat.toFixed(4)}, ${myLon.toFixed(4)})</td>
        <td>${nearest.county} ${nearest.sitename}</td>
        <td>${nearest.aqi}</td>
        <td>${nearest.status}</td>
      </tr>
    `;

    await saveToFirebaseCollections(name, nearest);
  });
}
</script>

</body>
</html>
